\chapter{Sprint: 4}

Following sprint 3 where we once again focused on adding stability to the
various GIRAF libraries, the focus for this sprint is to allow the next students
to have an easier and more efficient start than our own. Each year the various
libraries increase in size and complexity, and it becomes increasingly
important for new students to understand the code quickly. As such, the goal
for this sprint is to:

\say{The hand over to next years students allows understand the project
quickly.}\nl

For us this means that we will need for REST to be implemented and working
in the various libraries, as well as document the changes and additions.


\section{Tasks and Solutions}
Based on this goal we have been assigned the following tasks, see
\autoref{Tasks3}, which include the verification of our various solutions from
earlier sprints. These verification tasks have been marked with the tag
``Verify''.

\begin{table}[H]
\begin{centering}
\begin{tabular}{|l|p{9cm}|l|}
\hline
Number 	& Description & Man-hours \\ \hline
T772    & Verify: Security problem when changing system date/time & ??\\\hline
T785	& Verify: Handle crash such that the user does not get an error message and
is brought back to the launcher & 6\\ \hline
T822    & Verify: implementation of Grayscale & 6\\\hline
T830    & Never show the bug screen & 2 \\\hline
T836	& Remove old libraries from artifactory, and begin implementing REST
snapshot & ??\\\hline
T837	& Rework buttons to use methods called from XML & ??\\\hline
T859   	& Crosschecking wikis & ??\\\hline
T862  	& Guide: General development & ?? \\ \hline
T863	& Guide: Sources for starting out & ??\\ \hline
T864	& Guide: Android compatibility java8, sync and build & ??\\
\hline 
T865	& G609, G610: Update the Google store guide & 2\\\hline
T868    & REST: Fix Launcher app & 70 \\\hline
T870    & REST: Fix component-lib & 60\\\hline
T872 	& Documentation: Launcher & ??\\ \hline
T875 	& Launcher: Add functionality to Log In screen & 20\\\hline 
T878 	& Everyone: Fix bugs & ??\\ \hline
T889	& Launcher: Add an Institute to Guardian login & 12 \\\hline
\end{tabular}
\caption{Tasks for the third sprint}
\label{Tasks3}
\end{centering}
\end{table}

In the following subsections we will discuss the tasks and document our
solutions.

\subsection{T836, T868, T870: Implement REST in Launcher and Component-lib}
With the finalization of the beta snapshot of the REST library, we have been
tasked with implemeting REST into the launcher and the \textc{component-lib}
library. This process consists of removing the old \textc{db-lib} and replacing
all of its functionality with the equivalent in REST. While REST does not yet
contain all the functionality needed in order to totally replace \textc{db-lib},
we are still going to actively remove all parts of \textc{db-lib}, as the
database it is built upon is now deprecated.\nl

So far, we have chosen not to remove the old libraries from artifactory, as some
of the older applications, which we have not touched in this semester, are still
dependent on them, and we don't want to prevent them from building at all. The
exact implementation of REST is discussed in \autoref{UsingRest}.\nl

Implenting the new REST framework consists of two phases, which is presented in
the following exaples. The first phase is to replace database requests with the
REST equivalent, and the second phase is to replace the helper and controller
classes which have been implemented by \textc{db-lib}. Additionally, we discuss
the changes made to the \textc{GirafPictogramItemView} class of the
\textc{component-lib} library, as switching to REST has required us to split the
class into two individual ones.

\subsubsection{Replacing Database Requests}
In \textc{db-lib}, there was only a single request to the database, which was
made when the launcher started up. This request contained all the information
for the current user, which was not stored locally in shared preferences. In
REST, we no longer use shared preferences, but store all data on the database.
In addition, we make request to the database whenever we need to use data on a
user. This is done in order to make sure we always have to most up-to-date
data. Something which can be considered a problem with the current
implementation of REST, is that requests are always made asynchronously.
This requires the request to encapsulate all of the code which
makes use of the reqeuested data, as the rest of the program will continue to
execute while the request is being made. If the code was not encapsulated in the
request, it would cause nullPointerExceptions, as the code attempts to access an
object which is not retrieved yet. The design decisions behind the
implementation of REST are discussed in \autoref{UsingRest} in \autoref{S1CS},
where we also present a database request.

\subsubsection{Replacing Helpers and Controllers}
As we want to replace all functionality which originates
in \textc{db-lib}, we start by removing all imports from this library. Then,
since most of \textc{db-lib's} functionality is contained in a number of helper
classes, we remove these, and look at what they were used for. An example of a
helper class could be the \textc{profileApplicationController} in the
\textc{GirafFragment} class. This is shown in \autoref{pac}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Declaration of the ProfileApplicationController which is used to retrieve information about ProfileApplications, label = pac]
@Override 
void setListeners() { super.listener = new View.OnClickListener() {
	@Override
    	public void onClick(View v) {
			...
            final ProfileApplicationController pac = new ProfileApplicationController(getActivity());
			...
    	}
	};
}
\end{lstlisting}
\end{minipage}

Following the declaration and instantiation of the
\textc{ProfileApplicationController} under the identifier \textc{pac}, the
helper is used in the \textc{userHasApplicationInView} method. In this case,
\textc{pac} is used to retrieve a \textc{ProfileApplication}, which is a class
which maps users to applications, such that it can identify is a user is allowed
to access that application. If the user can't access the given application, the
returned value is null. The effect of this can be seen in \autoref{PACheck},
where the returned value is a boolean which is based on if \textc{thisPA} is
null.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Method which checks if a user is allowed to access an application, label = PACheck] 
private boolean userHasApplicationInView(ProfileApplicationController pac, Application app, Profile user) 
{ 
	ProfileApplication thisPA = pac.getProfileApplicationByProfileIdAndApplicationId(app, user);

    return thisPA != null;
}
\end{lstlisting}
\end{minipage}

Given that all of the presented functionality is based on the \textc{db-lib}
library, we will have to replace it with the REST equivalent. In REST,
\textc{Profiles} have been renamed to \textc{Users}, and has a settings object,
which contains information about that users settings. This object is stored on
the database, and can be retrieved through a request. The process of retrieving
objects from the database in presented in \autoref{UsingRest} in \autoref{S1CS}.
In the case of checking if users can access applications, we have replaced the
method in \autoref{PACheck} with the method named \textc{userCanAccessApp},
which can be seen in \autoref{ucaa}. In this method, we can simply acces the
user's settings object, and check if the given application appears on the users
list of applications. By doing this, we have actively replaced the
necessity of the \textc{db-lib} helpers.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = New method which replaces the functionality of the ProfileApplicationController, label = ucaa] 
private boolean userCanAccesApp(Application app, User user) 
{
	return user.getSettings().getAppsUserCanAccess().contains(app);
}
\end{lstlisting}
\end{minipage}

\subsubsection{Replacing ItemViews}
The \textc{GirafPictogramItemView} class is responsible for presenting
\textc{ItemViews} on the GUI. In the previous implementation, both Users and
Pictograms extended the ItemView class, as both of those classes contained
pictures or icons which should be presented on the GUI. As such, The
\textc{GirafPictogramItemView} class was used to present both of these
elements.\nl

In the \textc{rest-models} approach, many of the previous classes which were
part of \textc{db-Lib} have been deprecated, including the GIRAF approach to
using the \textc{ItemView} class. As such, we have had to split the
\textc{GirafPictogramItemView} class into two seperate classes, which handles
pictograms and users respectively. The class for pictogram retained the old
name, while the new class for users was named \textc{GirafUserItemView}. As both
pictograms and users still have fields for their icon or picture, the classes
have simply been specialized to not use ItemViews but their respective classes,
and whenever the image was accessed, we simply changed this code to reflect the
different objects methods of access to this field.




\subsection{T875 Launcher: Add functionality to Log In screen}
This task is centered around adding functionality to the login screen we made
in \autoref{LoginXML}, as REST is now ready to be implemented. The GUI is
implemented in the \textc{LoginActivity} class, where we create the reference
to XML layout and construct the needed listeners, this can be seen in
\autoref{onCreate} and \autoref{onLoginButtonClick}. The \textc{LoginController}
class handles the login method which consists of two nested requests to the
server.\nl

In \textc{LoginActivity} we use the \textc{onCreate} method, see
\autoref{onCreate}, to instantiate the \textc{LoginController} and set the
screen as \textc{R.layout.login\_activity}, which corresponds to the XML
file for the login screen. We then create references to the various UI elements,
such as the textboxes on \textbf{lines 7-8}. On \textbf{line 11-22} we create a
\textc{setOnKeyListener} for when the Enter key is pressed, which calls the
\textc{onLoginButtonClick} method.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Creating the correct references when logging in,
label = onCreate] public class LoginActivity extends GirafActivity {
	...
	public void onCreate(Bundle savedInstanceState) {
		controller = new LoginController(this);
    	setContentView(R.layout.login_activity);
		...
        usernameTextBox = (TextView) findViewById(R.id.username_textbox);
        passwordTextBox = (TextView) findViewById(R.id.password_textbox);
        
        //Tries to login when Enter is pressed
        passwordTextBox.setOnKeyListener(new View.OnKeyListener() {
            @Override
            public boolean onKey(View view, int keyCode, KeyEvent keyEvent) {
                if(keyEvent.getAction() == KeyEvent.ACTION_DOWN){
                    if(keyCode == KeyEvent.KEYCODE_ENTER){
                        onLoginButtonClick(view);
                        return true;
                    }
                }
                return false;
            }
        });
        ...
}
\end{lstlisting}
\end{minipage}

The \textc{onLoginButtonClick}, see \autoref{onLoginButtonClick}, method is used
to disable the elements the user can interact with, start the load animation and
pass the username and password to \textc{controller} via the \textc{login}
method.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Passes the user information and begins the waiting animation, label = onLoginButtonClick] 
public class LoginActivity extends GirafActivity 
{ 
...
	public void onLoginButtonClick(View view) {
        loginButton.setEnabled(false);
 		...
        findViewById(R.id.girafHeaderIcon).startAnimation(loadAnimation);
        controller.login(username, password);
    }
	...
}
\end{lstlisting}
\end{minipage}

In the \textc{LoginController} class we use the \textc{login} method to
communicate with the server through a couple different requests, which are
detailed more in \autoref{UsingRest}.\\

In this code example, \autoref{loginReq}, we Instantiate a \textc{RequestQueue}
on \textbf{line 4} along with a \textc{LoginRequest} on \textbf{lines 7-14}
which we add to the queue on \textbf{line 15}. When the server responds to our
login request can then either be granted or denied access. If we are denied
access the \textc{Response.ErrorListener} on \textbf{lines 11-13} uses an
\textc{onErrorResponse} method to displays a message depending on the type of
error it has received, this is further illustrated in
\autoref{CSLoginRequest3}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Verifing the user information through a login
request, label = loginReq] public class LoginController {
	...
    public void login(final String username, String password) {
        RequestQueue queue = RequestQueueHandler.getInstance(gui.getApplicationContext()).getRequestQueue();

        //Creates a login request which is then added to the queue later
        LoginRequest loginRequest = new LoginRequest(username, password,
        	new Response.Listener<Integer>() {
        		...
        	},
        	new Response.ErrorListener() {
        		...
        	}
   		);
		queue.add(loginRequest);
	}
}
\end{lstlisting}
\end{minipage}

When a login request is validated we proceed to the \textc{Response.Listener} on
\textbf{lines 8-10} of \autoref{loginReq}, this code is described in
\autoref{userReq}.\\
In the OnResponse listener on \textbf{lines 3-20} we make a \textc{GetRequest}
on \textbf{6} for a user with the same username and password as before. This is
because the \textc{LoginRequest} does not return a user. Inside the
\textc{Response.Listener} on \textbf{line 10-15} we proceed to pass the user
to \textc{homeIntent} and start the next activity.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = If the user information is authenticated we proceed
with a request for user, label = userReq] new Response.Listener<Integer>() {
	@Override
    public void onResponse(Integer statusCode) {
    	//Creates a GetRequest for the user, which is then added to the queue
    	//within the loginRequest 
    	GetRequest<User> userGetRequest = new GetRequest<User>(username, User.class, 
    	new Response.Listener<User>() {
        	//Passes the userinfo to homeIntent
            @Override
            public void onResponse(User response) {
            	Intent homeIntent = new Intent(gui, HomeActivity.class);
                homeIntent.putExtra(IntentConstants.CURRENT_USER,response);
                homeIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                gui.startActivity(homeIntent);
            }
        }, new Response.ErrorListener() {
			...
        });
        queue.add(userGetRequest);
	}
}
\end{lstlisting}
\end{minipage}

%institute screen
% Ny implementation til institution --> login request --> user request hvor user
% nu er af typen institution --> user selection screen Vi genbruger en
% user_selection screen

%No time for institute

\subsection{Guides and Help and Help For Future Students}
In order to help the next batch of students, every group has been tasked with
creating a set of guides. These guides are meant to explain the various
parts of GIRAF that are most likely going to be confusing, such as starting out,
how GIRAF is developed and how the various tools work together. The
majority of these guides are written by other groups can be found on the GIRAF
wiki\citep{GWiki}. As such \textbf{T862: Guide for general development},
\textbf{T863: Guide for starting out} and \textbf{T864: Guide for android
compatibility, java8, sync and build} can be considered resolved.

\subsubsection{T859: Crosscheck wikis}
The purpose of this task is to ensure that wikis are of acceptable state, this
is done having
\fix{}{write me}

\subsubsection{T865: Update the Google Store guide}

The goal of this task is to update the guide on releasing builds to Google
Store. By reading the guide from 2015 and comparing the pictures in it with
Google Stores current design, we can see that it has changed quite a bit since
the guide was written. All the changes of importances were due to additional
tabs which moved various parts of the functionality. We then updated the
pictures and along with the relevant part of text to better reflect the new
design.

\subsubsection{T872: Document the Launcher}

We have also included a short wikipedia page to describe the important parts of
\textc{Component Lib}, see \autoref{WikiCompLib}.


\subsection{Verification}
Throughout the prior sprints we have not been able to verify our solutions, as
such now that the Launcher is in a working state we can verify the appropriate
solutions.

\subsubsection{T785 and T830: Handle crash such that the user does not get an
error message and is brought back to the launcher}
Thoughout testing the launcher after the REST API was included, we see that when
we crash the bug screen is no longer shown. We have tried implementing the
return to launcher but have not been able to resolve it due to time constraints.
As such this task can only be considered partially resolved.

\subsubsection{T822: Verify the implementation of Grayscale}
We have removed all \textc{SharedPreferences}, including the one we used in
\autoref{grayEx2}, as such we have no way to see the users setting. We have thus
changed it to better make use of REST by making a request to the server for the
users setting, see \autoref{NEWsetGrayScaleUser}. As seen on \textbf{lines
xx-xy} we make a simple \textc{GetRequest<User>} pass the settings and activity to the
\textc{setGrayScaleForActivity} method.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Finds the grayscale setting for each user, label =
NEWsetGrayScaleUser] 
public class GrayScaleHelper {
	...
	public static void setGrayScaleForActivityByUser(final Activity activity, 
	  final User user){
		...
		GetRequest<User> userGetRequest = new GetRequest<User>(user.getUsername(), User.class, new Response.Listener<User>() {
            @Override
            public void onResponse(User response) {
           		if(response.getSettings() != null) {
               		setGrayScaleForActivity(activity, response.getSettings().getUseGrayScale());
               	}
	 			...
}
\end{lstlisting}
\end{minipage}

In \textc{setGrayScaleForActivity} we experience a problem as we in
\autoref{grayEx1} tried to use \textc{setGray} for each view. This does not work
correctly, as such we use the \textc{root View} on \textbf{line
5}, as we are able to affect the other views through it, as can be seen on
\autoref{NEWsetGrayScale}.

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = The root View is used instead of all the seperate
views, label = NEWsetGrayScale] public class GrayScaleHelper {
	...
    public static void setGrayScaleForActivity(Activity activity, boolean shouldBeGray) {
        //Get the root view
        View view = activity.getWindow().getDecorView().getRootView();
        setGray(view, shouldBeGray);
    }
    ...
}
\end{lstlisting}
\end{minipage}

There is a small problem as currently the \textc{dialogs} are not grayscaled
when the \textc{root View} is. We think this is because they are not attached to
it, see \autoref{GrayScaleColorDialog}, but due to time constraints we have
choosen to pass this particular part to next years students. 

\figx[0.2]{GrayScaleColorDialog}{An example of a colored dialog with a
gray scaled background.}

\subsubsection{T878: Fix bugs}
This is a task for every group. This sprint we have been busy implementing REST
in the Launcher and Component-lib, and as the deadline has come closer we are
under increasing time pressure to make it workable. As such we have chosen to
not directly work on this task and leave the minor bugs for next years students.
These bugs and missing features include:

\begin{itemize}
  \item Dialogs are in color while the rest of GIRAF is gray.
  \item It is possible to change users through settings.
  \item It is not possible to return to the guardian in settings as a new user
  has been logged in.
  \item SharedPreferences should be used for the Logic screen to determine if
  it needs to be in grayscale.
\end{itemize}

There are likely more bugs which we have not discovered.


\subsection{Unfinished and Invalid Tasks}\label{S4Invalid}
\begin{itemize}
  \item T772: Verify: Security problem when changing system date/time
  	\begin{itemize}
  		\item The orginal problem discoved during sprint 2 as seen in \autoref{T772}
 		was that the user could extend the login session by doing back in time on the
  		device.
		\item This is an issue because we do not check the time using some form of a
		time server, and therefor not able to detect this.  
		But now this task is invalid because the server now handles if a user is
		logged in, using tokens / cookies which the rest libary handes.
		\end{itemize}
  \item T837: Rework buttons to use methods called from XML
	\begin{itemize}
	  \item The purpose of this task is to increase the quelity of the code, and to
	  reduce unnecessary clutter. This can be done as specifying listeners in the
	  code itself is unnecessary, and can simply be done from the xml file itself.
	  \item We have managed to do this for a number of classes, but have yet to
	  do this for all classes in the Launcher. This approach can, and should, be
	  used in all xml files for GIRAF.
	  \end{itemize}
  \item T889: Add an Institute to Guardian login
   \begin{itemize}
     \item This task is an extension of \textbf{T875}, as it is intended for an
     institute-type user to be log in as a guardian. 
     \item This task is considered unfinished due to time constraints as there
     were several changes happening to REST while we were busy implementing it.
     It was not considered a vital task, and is as such left for the next years
     students.
   \end{itemize}
\end{itemize}