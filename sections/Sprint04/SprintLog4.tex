\chapter{Sprint: 4}

Following sprint 3 where we once again focused on adding stability to the
various GIRAF libraries, the focus for this sprint is to allow the next students
to have an easier and more efficient start than our own. Each year the various
libraries increase in size and complexity, and it becomes increasingly
important for new students to understand the code quickly. As such, the goal
for this sprint is to:

\say{The hand over to next years students allows understand the project
quickly.}\nl

For us this means that we will need for REST to be implemented and working
in the various libraries, as well as document the changes and additions.


\section{Tasks and Solutions}
Based on this goal we have been assigned the following tasks, see
\autoref{Tasks3}, which include the verification of our various solutions from
earlier sprints. These verification tasks have been marked with the tag
``Verify''.

\begin{table}[H]
\begin{centering}
\begin{tabular}{|l|p{9cm}|l|}
\hline
Number 	& Description & Man-hours \\ \hline
T772    & Verify: Security problem when changing system date/time & ??\\\hline
T785	& Verify: Handle crash such that the user does not get an error message and
is brought back to the launcher & 6\\ \hline
T822    & Verify: implementation of Grayscale & 6\\\hline
T830    & Never show the bug screen & 2 \\\hline
T836	& Remove old libraries from artifactory, and begin implementing REST
snapshot & ??\\\hline
T859   	& Everyone: Crosschecking wikis & ??\\\hline
T862  	& Everyone: Guide: General development & ?? \\ \hline
T863	& Everyone: Sources for starting out & ??\\ \hline
T864	& G609, G610, G613: Guide: Android compatibility java8, sync + build & ??\\
\hline 
T865	& G609, G610: Update the Google store guide & 2\\\hline
T868    & REST: Fix Launcher app & 70 \\\hline
T870    & REST: Fix component-lib & 60\\\hline
T872 	& Documentation: Launcher & ??\\ \hline
T873 	& G609, G612: Documentation: Pictosearch & ??\\ \hline
T875 	& Launcher: Add functionality to Log In screen & 20\\\hline 
T878 	& Everyone: Fix bugs & ??\\ \hline
T889	& Launcher: Add an Institute to Guardian login & 12 \\\hline
\end{tabular}
\caption{Tasks for the third sprint}
\label{Tasks3}
\end{centering}
\end{table}

In the following subsections we will discuss the tasks and document our
solutions.

\subsection{T785: Verify: Handle crash such that the user does not get an error message and
is brought back to the launcher}
Thoughout testing the finished launcher after the rest api was included, we see
that when we get an exception we do not crash and show the bug screen, which
would also be funky because the code does not exist to show the bugscreen, and
return to the launcher code has not been tested yet ( kommentar til os selv,
det kode virker heller ikke efter hensighten, det skal lige fixes)

\subsection{T822: Verify the implementation of Grayscale}

\subsection{T836: Remove old libraries from artifactory, and begin implementing REST
snapshot}
We have not removed the old libraries from artifactory, because some of the
older apps might still need them in the transition to the new rest api. But they
are no longer used as a deprendecy in the launcher or giraf component lib and we
have implementet not just the rest snapshot but the full rest relase which can
be seen how we use it in the rest fix launcher.

\subsection{T859: Crosscheck wikis}

\subsection{T862: Create guides for the general development of GIRAF}

\subsection{T863: Create sources for starting out}

\subsection{T864: Create a guide for Android compatibility java8, sync + build}

\subsection{T865: Update the Google Store guide}
\fix{Can properly be placed in a subsection along with the other guides}{}

This task is part of the overall goal to ensure that next years students are
well equipped to begin working on GIRAF. The goal of this task is to update the
guide on releasing builds to Google Store. By reading the guide from 2015 and
comparing the pictures in it with Google Stores current design, we can see that
it has changed quite a bit since the guide was written. All the changes of
importances were due to additional tabs which moved various parts of the
functionality. We then updated the pictures and along with the relevant part of
text to better reflect the new design.

\fix{Consider if we need to add pics - it was very minor work after all}{}

\subsection{T868: REST: Fix Launcher app}
Implementing REST --> We can't make a request handler due to not being able
to use lambda expression since we don't use java 8.
This means we have to Responses within responses since we need some error
handling, although later in the sprint a sort of solution to the problem have
been made, but this was so late that all places where we uses rest we already
have implementen it using the other but still supported way of doing requests.
We have also remove all the usage of profiels and switched them out for users
from the new rest model libray.

code show an example of how we use reqeuest

\subsection{T870 - REST: Fix component-lib}
With the introduction of the \textc{rest-models} library, and the removal of the
\textc{db-lib} library, the previously implemented database communication has
been rendered invalid. As such, it needs to be replaced by the equivalent
\textc{rest-models} approach. As this change spans a large part of the 58
classes in the \textc{component-lib} library, the presentation of this task will
focus on the class \textc{GirafPictogramItemView}, as it is one of the
classes which have recieved the most changes.\nl

The \textc{GirafPictogramItemView} class is responsible for presenting ItemViews
on the GUI (graphical use interface). In the presented implementation, both
Users and Pictograms extended the ItemView class, as both of those classes
contained pictures or icons which should be presented on the GUI. As such, The
\textc{GirafPictogramItemView} class was used to present both of these
elements.\nl

In the rest-models approach, many of the previous classes which were part of
the db-lib library have been deprecated, including the ItemView class. As such,
we have had to split the \textc{GirafPictogramItemView} class into two seperate
classes, which handles pictograms and users respectively. The class for
pictogram retained the old name, while the new class for users was named
\textc{GirafUserItemView}.\nl

Changes to the mplementation of server requests can be seen in
\autoref{UsingRest} where the new REST approach is presented and discussed.
\fix{}{Write some more}

\subsection{T872: Document the Launcher}

\subsection{T873: Document PictoSearch}

\subsection{T875, T889 - Launcher: Add functionality to Log In screen and add an
Institute to Guardian login}

This task is centered around adding functionality to the login screen we made
in \autoref{LoginXML}, as REST is now ready to be implemented. The GUI is
implemented in the \textc{LoginActivity} class, where we create the reference
to XML layout and construct the needed listeners, this can be seen in
\autoref{onCreate} and \autoref{onLoginButtonClick}. The \textc{LoginController}
class handles the login method which consists of two nested requests to the
server.\nl

In \textc{LoginActivity} we use the \textc{onCreate} method, see
\autoref{onCreate}, to instantiate the \textc{LoginController} and set the
screen as \textc{R.layout.login\_activity}, which corresponds to the XML
file for the login screen. We then create references to the various UI elements,
such as the textboxes on \textbf{lines 7-8}. On \textbf{line 11-22} we create a
\textc{setOnKeyListener} for when the Enter key is pressed, which calls the
\textc{onLoginButtonClick} method.\fix{fix captions}{}\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = ???, label = onCreate] 
public class LoginActivity extends GirafActivity {
	...
	public void onCreate(Bundle savedInstanceState) {
		controller = new LoginController(this);
    	setContentView(R.layout.login_activity);
		...
        usernameTextBox = (TextView) findViewById(R.id.username_textbox);
        passwordTextBox = (TextView) findViewById(R.id.password_textbox);
        
        //Tries to login when Enter is pressed
        passwordTextBox.setOnKeyListener(new View.OnKeyListener() {
            @Override
            public boolean onKey(View view, int keyCode, KeyEvent keyEvent) {
                if(keyEvent.getAction() == KeyEvent.ACTION_DOWN){
                    if(keyCode == KeyEvent.KEYCODE_ENTER){
                        onLoginButtonClick(view);
                        return true;
                    }
                }
                return false;
            }
        });
        ...
}
\end{lstlisting}
\end{minipage}

The \textc{onLoginButtonClick}, see \autoref{onLoginButtonClick}, method is used
to disable the elements the user can interact with, start the load animation and
pass the username and password to \textc{controller} via the \textc{login}
method.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = The effects of trying to login , label =
onLoginButtonClick] 
public class LoginActivity extends GirafActivity {
	...
	public void onLoginButtonClick(View view) {
        loginButton.setEnabled(false);
 		...
        findViewById(R.id.girafHeaderIcon).startAnimation(loadAnimation);
        controller.login(username, password);
    }
	...
\end{lstlisting}
\end{minipage}

In the \textc{LoginController} class we use the \textc{login} method to
communicate with the server through a couple different requests, which are
detailed more in \autoref{UsingRest}.\\




\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = ???, label = loginReq]
public class LoginController {
	...
    public void login(final String username, String password) {
        queue = RequestQueueHandler.getInstance(gui.getApplicationContext()).getRequestQueue();

        //Creates a login request which is then added to the queue later
        LoginRequest loginRequest = new LoginRequest(username, password,
        	new Response.Listener<Integer>() {
        		...
        	},
        	new Response.ErrorListener() {
        		...
        	}
   		);
		queue.add(loginRequest);
	}
}
\end{lstlisting}
\end{minipage}


is handled by first
using our getting a \textc{request queue}, which is discussed in
\autoref{UsingRest}. We then begin with the login request, which
takes as an input: a username, a password, an OnResponse listener and an OnError listerner. The username and password are taken from the
text fields where the user has written them.

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = ??? , label = loginController] 
public class LoginController {
	...
	
}
\end{lstlisting}
\end{minipage}

%OnResponse chains
In the OnResponse listener, which we reach if the login request is validated, we
then proceed with a user request, where we again input a username, a password,
an OnResponse listener and an OnError listener. In the OnResponse listener we
will upon validation receive the user as a user-type object called response. We
then proceed to start the home activity \fix{add more}{}.

%OnError
blablabla

%institute screen
An additional requirement is needed as it we need a way for an institute-level
user to\ldots. 



%Tanker:
%implementer login button via:
%Login request --> user request --> home activity
%(Refer til steder hvor vi har beskrevet requestsne?)

% Ny implementation til institution --> login request --> user request hvor user
% nu er af typen institution --> user selection screen Vi genbruger en
% user_selection screen


\subsection{T878: Fix bugs}

\subsection{Unfinished and Invalid Tasks}\label{S4Invalid}
\begin{itemize}
  \item T772: Verify: Security problem when changing system date/time
  	\begin{itemize}
  		\item The orginal problem discoved during sprint 2 as seen in \autoref{T772}
 		was that the user could extend the login session by doing back in time on the
  		device.
		This issue is because we do not check the time using some form of a time
		server, and therefor not able to detect this.  
		But now this task is invalid because the server now handles if a user is
		logged in, using tokens / cookies which the rest libary handes.
		\end{itemize}
  \item T830: Never show the bug screen
  	\begin{itemize}
  		\item This task should still be fixed given that we removed that code in
  		sprint 3
	\end{itemize}
\end{itemize}
