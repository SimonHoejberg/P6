\chapter{Sprint: 02}
Following the first sprint each group has gained a deeper understanding of how
the individual applications are designed and implemented. Based on this
knowledge, this sprint will be used to further develop the features which were
worked on by the previous year's students.\nl

During the first sprint, the Product-Owner group (SW612) created a number of
user stories based on a meeting with the users of the system. As the first
sprint was used to introduce us to the GIRAF project, the tasks were for the
most part not based on the content of these user stories. As the second sprint
is focused on further developing both existing and new features, the user
stories have been used to define the goals for this sprint. As such, the goals
of this sprint has been defined as the following:\\
\say{Increase the stability of the libraries used, and the accessibility and
usability of the applications, to fulfill user stories 1, 4 and 6. For server
and client libraries, begin implementation of functionalities for user stories
2, 3 and 4.} The user stories can be seen in \autoref{Sprint2UserStories}.


\begin{table}[H]
\centering 
\begin{tabular}{|l|p{12.5cm}|}
\hline
Nr. & User Story \\\hline
1. & As one of the children who use the system, i want the system to be 
\textbf{as stable as possible}, as my mental problems require that of the tools
which i use. \\ \hline
2. & As a pedagogue I want the ability to \textbf{replace pictures} and icons
for the children in the system.\\ \hline
3. & As a pedagogue, it is very important to be able to \textbf{create a weekly
schedule} and manage the tasks the children can see at any given time.\\ \hline
4. & As a user of the system, the \textbf{response time} is an important
factor.\\ \hline
6. & As a user of the system, I'd like the interface to be \textbf{simple},
things should never be more than \textbf{2-3 taps} away. \\\hline
\end{tabular}
\caption{User stories for sprint 2}
\label{Sprint2UserStories}
\end{table}

While our initial area of responsibility was focused on the \textc{Launcher} and
\textc{Pictogram Searcher}, for this sprint we have chosen to expand this to
also include developing a new \textc{Login System} and refactoring the
\textc{Pictogram Reader}. This choice is based on the fact, that currently only
two groups are working on developing the front-end for applications (SW609 and
SW610), and our group is currently best suited to handle these new tasks. As an
additional task for this project, the project groups have concluded that our
projects should also include documentation of the applications and classes we
are working on. This documentation should be added to the GIRAF wiki.

\section{Tasks}
Based on our expanded area of responsibility and the need to develop a new login
system, we have been assigned the tasks presented in \autoref{SprintTwoTasks}.

\begin{table}[H]
\centering
\begin{tabular}{|l|l|l|}
\hline
Number	& Description & Man-hours												\\\hline
T634  	& Wiki: Continually update Launcher info on the wiki & 8\\\hline 
T671    & Implement system to retrieve stack-trace from system crashes & ?
\\\hline 
T705	& Launcher: Evaluate/Change need to log out when changing  to guardian
& ? \\\hline 
T708    & Meeting: Discuss overall design goals for the GIRAF GUI & 64\\\hline
T709	& Meeting: Define UI questions & 32 \\\hline 
T722   	& Launcher: Save login session. Prevent automatic logout before 8 hours
&3 \\\hline 
T724   	& Launcher: Prevent crash caused by other applications
crashing & 2 \\\hline 
T725  	& Search: Improve overall performance (If possible)	& 8 \\\hline 
T726    & Meeting: Discuss REST interface and database communication & 16
\\\hline 
T727    & Reader: Fix crash on failed server communication  & 2				\\\hline 
T728	& Reader: Refactor and CheckStyle  & 60\\\hline
T731    & LogIn: Design new login system GUI & 16     			\\\hline
T732    & Launcher: Evaluate what elements should be visible to
child/guardian & ?\\\hline 
T733    & Search: Implement vertical screen functionality & 16   			\\\hline 
T739    & Wiki: Document pictosearch info on the wiki & 64	\\\hline
T772    & Security problem when changing system date/time & 1 \\\hline
\end{tabular}
\caption{Tasks for the second sprint (Group SW609)} 
\label{SprintTwoTasks}    
\end{table} 

In the following subsections, we will elaborate upon each of the task, and
document what actions we have taken in order to resolve the issues.

\newpage
\subsection{T671 - Output stack-trace to Google on system crash}
Following the development last year, whenever a GIRAF application crashed, the
system would present a splash-screen with the stack trace, and inform the user
that this information was sent to the GIRAF development team through Google
Analytics. An example of this screen can be seen in \autoref{GBugSplash}.

\figx{GBugSplash}{Splash screen presented on unhandled exception}

While testing the GIRAF applications, we noticed that the code necessary for
sending the stack-trace was not present in a number of the applications. After
reviewing the code, we concluded that for some applications, the previous
semester's students only implemented the splash-screen, without implmenting the
actual code which was supposed to output the stack-trace. In order to solve this
problem, we have chosen to implement this system ourselves.\nl

In the library \textc{giraf-component-lib} exists the class
\textc{GirafBugSplashActivity} which is extended from the \textc{GirafActivity}
class. This class is responsible for displaying a splash screen with the
stack-trace whenever a GIRAF application encounters an unhandled exception. As
we want to create a generalized approach to sending stack-traces, we have chosen
to expand upon the \textc{GirafBugSplashActivity} class, and add functionality
to send the stack trace to Google Analytics in addition to simply showing it on
the splash screen. This should allow all GIRAF applications to correctly send
the stack-trace when the applications crash. \nl

Whenever an unhandled exception occurs in an application, it is caught in the
\textc{GirafActivity} class's \textc{UncaughtExceptionHandler}. The exception is
then passed to an \textc{Intent}, which is used to start a
\textc{GirafBugSplashActivity}. These steps can be seen in
\autoref{BugCatch}.\nl


\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Catching exceptions and starting creating a \textc{GirafBugSplashActivity}, label = BugCatch]

public class GirafActivity extends FragmentActivity {
	...
    protected void onCreate(final Bundle savedInstanceState) {
    	...
    	Thread.currentThread().setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
            @Override
            public void uncaughtException(Thread thread, final Throwable ex) {
            ...
            Intent intent = new Intent(getApplicationContext(), GirafBugSplashActivity.class);
			startActivity(intent);
			...
		}
		...
	}
	...
}
...			
\end{lstlisting}
\end{minipage}

The current implementation's approach to handling the exceptions, is
that whenever a \textc{GirafBugSplashActivity} is created the exception message
and the stack trace are saved as the two strings \textc{message} and
\textc{stacktrace} respectively. These strings are then presented on the splash
screen. In this implementation, no data is sent to Google Analytics. This can be
seen in \autoref{GSplash}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Code responsible for showing the GIRAF splash screen., label = GSplash]
public class GirafBugSplashActivity extends GirafActivity { 
	public static final String EXCEPTION_MESSAGE_TAG = "EXCEPTION_MESSAGE_TAG"; 
	public static final String EXCEPTION_STACKTRACE_TAG = "EXCEPTION_STACKTRACE_TAG";
	
	@Override
    public void onCreate(Bundle savedInstanceState) {
		...
		String message = getIntent().getExtras().getString(EXCEPTION_MESSAGE_TAG);
        String stacktrace = getIntent().getExtras().getString(EXCEPTION_STACKTRACE_TAG);
        
        //Show stacktrace on splash screen
        ...
    }	
	...
}
\end{lstlisting}
\end{minipage}

In order to resolve this issue, we implement an alternative approach with the
additional functionality to send information to Google Analytics. Our solution
can be seen in \autoref{BugOurSol}, where we start by defining the strings
\textc{EXCEPTION\_TAG} and \textc{TRACKING\_ID\_TAG}, which are used as tags for
the \textc{getExtras} method on the \textc{Intent}. As we intend to send the
stacktrace to Google Analytics, instead of a string, we use a variable of type \textc{Exception} to
contain the exception's information. We use the method \textc{getStackTraceArray} to change the
\textc{Exception} into a readable format, which we in turn use to define the
strings \textc{message} and \textc{stacktrace}, which are used to present the
splash screen. We create a \textc{Tracker}, which is a type used to send
information to Google Analytics, and use the \textc{send} method to send
send the information. In order to review this information, we can go to the
Google Developer webpage for our application.\nl 

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Our approach to outputting the stack trace, label = BugOurSol]

public class GirafBugSplashActivity extends GirafActivity {
	public static final String EXCEPTION_TAG = "EXCEPTION_TAG";
    public static final String TRACKING_ID_TAG = "TRACKING_ID_TAG";
    
	public void onCreate(Bundle savedInstanceState) {
		...
		Exception ex = (Exception) getIntent().getExtras().getSerializable(EXCEPTION_TAG); 
		String trackingId = getIntent().getExtras().getString(TRACKING_ID_TAG);
		
		String message = ex.getMessage();
        String stacktrace = getStackTraceArray(ex.getStackTrace());
        ...
        Tracker tracker = GoogleAnalytics.getInstance(this).getTracker(trackingId);
        tracker.send(MapBuilder.createException(new StandardExceptionParser(this,null)
            .getDescription(Thread.currentThread().getName(),ex),true)
            .build());
    }

	private String getStackTraceArray(StackTraceElement[] stackTraceElements) {
        String[] stackTraceLines = new String[stackTraceElements.length];
        int i = 0;
        
        for (StackTraceElement se : stackTraceElements) {
            stackTraceLines[i++] = se.toString();
        }
        
        StringBuilder builder = new StringBuilder();
        
        for (String s : stackTraceLines) {
            builder.append(s);
            builder.append("\n");
        }
        
        return builder.toString();
    }
\end{lstlisting}
\end{minipage}

\subsection{T708, T709, T731 -  GUI meetings \& GIRAF login GUI design}
During the first sprint, group SW612 held a meeting with the system users, and
determined a number of improvements which should be made, in order to increase
overall user satisfaction. One of these wishes were to replace the existing
login system, which uses QR codes, to a proper login system using usernames and
passwords.\nl

As this task requires a high level of coorporation with other groups and is
expected to span over multiple sprints, the entirety of this task has been moved
to \autoref{sec:LoginColab}, where we describe the full details of developing
the new login system.

\subsection{T722 - Prevent login session from expiring}
While testing the launcher during the first sprint, we noticed that users would
sometimes be logged out automatically before the defined interval of 8
hours. This poses a problem, as users can become frustrated with the system,
if they constantly have to renew their login session.\nl

While we have been unable to determine the exact cause of the problem, we have
identified a potential problem with the current implementation, where
information about the login session is stored in the shared preferences in a
possibly faulty manner. This original approach can be seen in
\autoref{OrginalSessionSaving}, where the previous students are using apply to
save the time of authentication and the ID of the guardian to the shared
preferences.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Original approach to saving login session, label =
OrginalSessionSaving]
public static void saveLogInData(final Context context, final long id, final long loginTime) {
    final SharedPreferences sp = context.getSharedPreferences(Constants.LOGIN_SESSION_INFO, 0);
    final SharedPreferences.Editor editor = sp.edit();
    editor.putLong(Constants.LOGIN_TIME, loginTime);
    editor.putLong(Constants.GUARDIAN_ID, id);
    editor.apply();
}
\end{lstlisting} 
\end{minipage}

Our solution to this problem, which can be seen in
\autoref{SolutionSessionSaving}, is to change the \textc{apply} in the code to
\textc{commit}. The difference between these two is that \textc{apply} writes
the information \textc{asynchronously}, where \textc{commit}
writes it \textc{synchronously}. Using \textc{commit} means that we are informed
if the writing failed, which allows us first of all to write it to the log and
secondly we could implement that it trieds again, until it is correctly
stored.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Our solution to saving login session, label
=SolutionSessionSaving ]
public static void saveLogInData(final Context context, final long id, final long loginTime) {
    final SharedPreferences sp = context.getSharedPreferences(Constants.LOGIN_SESSION_INFO, 0);
    final SharedPreferences.Editor editor = sp.edit();
    editor.putLong(Constants.LOGIN_TIME, loginTime);
    editor.putLong(Constants.GUARDIAN_ID, id);
    Boolean succes = editor.commit();
    if(!succes){
    	Log.e("Launcher","Writing to Shared Preferneces failed");
	}
} 
\end{lstlisting} 
\end{minipage}

After testing this solution, we have determined that our solution has correctly
solved the problem. As such, we assume that we were correct in attributing the
problem to faulty communication with the shared prefernces, which we have
resolved by using \textc{commit} instead of \textc{apply}.\nl

While designing this solution, we found security issue which would allow a user
to extend their login session indefinitely. This issue has been converted to a
new task, which can be seen in \autoref{T772}.

\subsection{T724 - Launcher: Prevent crash when child application crashes}
While testing the applications during the first sprint, one of the other groups
identified a crash in the launcher, which occoured when one of the GIRAF
applications crashed. Based on the reported issues, we have tried to
replicate the crash, but we have so far been unable to. Due to the importance of
increasing the stability of the launcher, we have chosen to attempt to prevent
future crashes of this nature.\nl

The original approach to launching applications can be seen in
\autoref{OriginalLaunch}, where the \textc{startActivity} method is called on an
Android \textc{Context}, which is an abstract class containing information an
application, such as application-level operations like
\textc{launch}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Original approach to launching applications., label = OriginalLaunch]
public static void secureStartActivity(Context context, Intent intent) {
	if (intent.resolveActivity(context.getPackageManager()) != null) {	
    	context.startActivity(intent);
	}
	...
}
\end{lstlisting}
\end{minipage}

While we have no crash log to confirm our suspicions, we believe that the
launcher could crash due to the thrown exception being returned to the launcher.
As such, we have chosen to implement a try-catch structure, which should prevent
the launcher from crashing, if a child-application crashes. Our solution can be 
seen in \autoref{NewLaunch}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = New approach to launching applications., label = NewLaunch] 
public static void secureStartActivity(Context context, Intent intent) {
	if (intent.resolveActivity(context.getPackageManager()) != null) {
    	try {
        	context.startActivity(intent);
        } catch (Exception e) {
        	return;
        }
        ...
    }
...
\end{lstlisting}
\end{minipage}

\subsection{T725 - Search: Improve overall performance (If possible)}
Following task T660 in the first sprint, we have once again been tasked with
improving the performance of the search in \textc{pictosearch}. While most
of the performance increases must be done serverside, after reviewing our work
in the first sprint, we have concluded that minor performance increases can
still be made.\nl

We have attempted to increase the search speed by using the techniques taught in
the Computer Architecture course, in regards to optimizing the performance of
loop structures. This has simply been done by moving all unnecessary statements
and method calls outside of the loops. This approach has been implemented
throughout the \textc{pictosearch-lib} library.\nl

Considering that the build tools are not currently operational, as described in
\autoref{S1Retro}, as of this time, we have been unable to test this solution
and measure any performance increases.

\subsection{T726 - Meeting: Discuss REST interface and database communication}
During the first sprint, we held a meeting with groups SW610 and SW613 in order
to determine the database requirements for the individual applications. Once
again, during the second sprint, we held another meeting in order to discuss
further requirements which were identified during the first sprint. The purpose
of these meetings have been to allow for application/database communication,
structuring the database information and giving the applications access to all
necessary resources.\nl

Due to the complex nature of this task, and the coorporation with the other
groups, the entirety of this task has been moved to \autoref{S1CS}, where we
explain the contents of the meetings, the drawn conclusions, and how the results
of the meetings have been reflected in the implemented code.


\subsection{T727 - Reader: Fix crash on failed retrieval of audio file}
\label{T727}
During the initial sprint, we tested a number of the GIRAF
applications in order to better understand the GIRAF GUI design framework. While doing this, we
identified an \textc{IndexOutOfBoundsException} in the \textc{pictoreader}
application, which occours if we press the \textc{Play} button while no
pictograms are chosen. This error occours as the application attempts to access
the 0th element of the array of pictograms to read aloud. This can be seen in
\autoref{BTNPlay}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Accessing the 0th element of a null array., label = BTNPlay] 
btnPlay.setOnClickListener(new View.OnClickListener() {
	public void onClick(View v) {
	...
	if (sentencePictogramList.get(0) != null) {
		...
	}
...
}
\end{lstlisting}
\end{minipage}

It would appear that currently a check is made to make sure that the first
pictogram in the list is not null, but that there is no safeguards to make sure
that the list is not empty. While we question the necessity of the current
check, we have chosen to keep it, and simply add another check to make sure that
the array is not empty. If the array is empty, the expression should short
circuit, and the check on the first element of the array is never made. This
should prevent the case where the 0th element is accessed on an empty array. Our
solution can be seen in \autoref{BTNPlayFixed}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Our solution to the presented problem., label = BTNPlayFixed] 
btnPlay.setOnClickListener(new View.OnClickListener() {
	public void onClick(View v) {
	...
	if (!sentencePictogramList.isEmpty() && sentencePictogramList.get(0) != null) {
		...
	}
...
}
\end{lstlisting}
\end{minipage}

\subsection{T733 - Search: Implement vertical screen functionality}
During the first sprint, group SW610 was testing the Weekplanner application,
and noticed that some activities did not support vertical orientation of the
screen. Due to the inconsistancy of only some activities supporting this, we
have agreed to implement vertical functionality in the pictosearch activity.\nl

If an android activity is to support changing the orientation of its GUI, it
must contain a unique specification for each orientation. This is done in the
form of folder, containing an .XML file specifying the GUI. This means, that its
resource folder \textc{res} must contain subfolders named \textc{layout},
\textc{layout-port}, and \textc{layout-land}. The folders \textc{layout-port}
and \textc{layout-land} contain a defined layout for vertical and horizontal
orientation respectively, while \textc{layout} contains a default layout, which
is used if the other folders do not exist.\nl

In the current version of \textc{pictosearch-lib}, only the default folder
\textc{layout} exists. This horizontal layout can be seen in
\autoref{SearchHorizon}.

\figx{SearchHorizon}{Horizontal design for the \textc{activity\_picto\_admin\_main.xml} file, as presented in the Android Studio designer}
    
In order to allow for vertical orientation, we have chosen to redesign and
implement a new version of the activity. Simply put, we have copied the files
for the horizontal layout, added them to a new folder called
\textc{layout-port}, and redesigned the layout to be vertical. Our newly
designed layout can be seen in \autoref{SearchVert}.

\figx{SearchVert}{New vertical design for the
\textc{activity\_picto\_admin\_main.xml} file, as presented in the Android
Studio designer.}

Finally, after designing the new layout, we needed to allow for the screen
orientation to change, as this is not allowed in the current version of
pictosearch. This was done by changing the \textc{android:screenOrientation}
variable in the \textc{AndroidManifest.xml} file from \textc{landscape} to
\textc{fullSensor}. Setting the variable to \textc{fullSensor} allows the tablet
to use its sensors to set the orientation of the screen. This can be seen in
\autoref{OrientAllow}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Allowing changes to the screen orientation., label = OrientAllow] 
<activity
	android:name="dk.aau.cs.giraf.pictosearch.PictoAdminMain"
    ...
    android:screenOrientation="fullSensor" >
    ...
</activity>
\end{lstlisting}
\end{minipage}

\subsection{T772 - Security problem when changing system date/time}\label{T772}
This issue was discovered while solving he session expiring task. The issue is
that even after you have been logged out of GIRAF and are asked for a QR code,
you can close the launcher and change the date or time such that the session is
still active and there is no lower cap to which the login screen is shown. The
first sub issue is that the session token is not deleted when a session expires.
This has been fixed by adding the call to logOutIntent which can be seen in
\autoref{FixNonDeletToken}.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = Our solution to not clearing the token, label =
FixNonDeletToken] 
private void findOldSession() {
if (LauncherUtility.sessionExpired(this)) {
	LauncherUtility.logOutIntent(this);
    oldSessionGuardianId = -1L;
}
...
\end{lstlisting} 
\end{minipage}

logOutIntent only calls clearAuthData which can be seen in
\autoref{clearAuthData} which overwrites the saved information about the
session in the shared preferences.\nl

\begin{minipage}[H]{\linewidth}
\begin{lstlisting}[caption = ClearAuthData methode, label = clearAuthData]
private static void clearAuthData(final Context context) {
    final SharedPreferences sp = context.getSharedPreferences(Constants.LOGIN_SESSION_INFO, 0);
    final SharedPreferences.Editor editor = sp.edit();
    editor.putLong(Constants.LOGIN_TIME, 1);
    editor.putLong(Constants.GUARDIAN_ID, -1);
    editor.putLong(Constants.CHILD_ID, -1);
    Boolean succes = editor.commit();
    if(!succes){
    	Log.e("Launcher","Writing to Shared Preferneces failed");
    }
}
\end{lstlisting} 
\end{minipage}

The other part of the issue about the date / time problem is not solved at the
moment, because in the future we might get the time from the server or the server
might invalidate the tokens.


\subsection{Unfinished and Invalid Tasks}
\begin{itemize}
  \item T634 - Wiki: Continually update Launcher info on the wiki \& T739 -
  Wiki: Document pictosearch info on the wiki
  \begin{itemize}
  	\item The purpose of these task is to document the launcher and pictosearch
  	on the GIRAF wiki for next years students. 
  	\item We have not finished these task because first they are continues tasks
  	and because of the priority of these task compared to the other tasks.
  \end{itemize}
  \item T705 - Launcher: Evaluate/Change need to log out when changing  to
  guardian
  \begin{itemize}
  	\item The purpose of this task is together with Group SW612 to find out if
  	the current implementation of the switch between citizen to guardian is
  	correct. 
  	\item Group SW612 asked the users about it and it was still the way that the
  	switch from  wanted it. Therefore we have invalidated the task.
  \end{itemize}
  \item T728 - Reader: Refactor and CheckStyle
    \begin{itemize}
  	\item The purpose of this task is to improve the already written code from
  	last years students. 
  	\item We have from the start of the sprint down prioritised this task,
  	because this application is not part of the minimal viable product and as
  	such should only be worked on if the other tasks are complected. Therefore
  	this task has not been worked on, other then the small bug fix seen in
  	\autoref{T727} and the CheckStyle fixes.
  \end{itemize}
  \item T732 - Launcher: Evaluate what elements should be visible to
child/guardian
  \begin{itemize}
  	\item The purpose of this task is to evaluate and remove elements that should
  	be visible to citizens.
  	\item We have found no elements that needs to be removed and therefor we have
  	invalidated this task.
  \end{itemize}
\end{itemize}





















